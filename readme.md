# Arduino pro micro - записки исследователя #

[Arduino pro micro](http://www.pighixxx.com/test/2016/07/pro-micro-pinout/) - аналог arduino на чипе ATmega32U4, идентифицируется как "Arduino Leonardo". При заказе мне чертовски повезло, хотел брать "arduino pro mini" но ее не оказалось и выбор пал на эту модель. Как выяснилось позже - это единственный чип который официально может делать вывод через USB как HID устройство (эмуляция клавиатуры и мыши, для других плат потребуется танцы с бубнами).

![Распиновка](/images/pro_micro_pinout_v1_0_blue1.png)

Критерии выбора были:
1. Цена. В лом было платить 1000 рублей за неведомо что. Итого: 325 рублей а Амперкоте.
2. Наличие USB порта. Выяснилось, что есть модели без USB, для прошивки которых потребуется программатор.
3. Наличие впаянных ножек. К сожалению для arduino pro micro ножки прилагались отдельно, они небыли припаяны, пришлось паять самому...

Также были заказаны:
1. Монтажная палата.
2. Набор соединительных проводов разных типов (как показала практика проводки папа-папа востребованы более всего, их стоит брать побольше).
3. Пульт ДУ.
4. Кнопочки разных цветов - 3 штуки.
5. Модуль для чтения RFID меток - такие чипы в виде спиральки которые вклеивают в книги, одежу и т.п. в магазинах чтобы не сперли чего, также RFID использует мосгортранс в билетиках, но главная тема ради чего все это мутится, аутентификация компьютера (ввод пароля) от брелока (прилагается к модулю) или от карты. Именно тут понадобится особенность чипа ATmega32U4 работать как HID устройство, то есть приложили брелок оно напечатало пароль.

Позже оказалось, что неплохо было бы закупить:
1. Резисторы на 10кОм для подключения кнопок (можно и без них, но рекомендуют).
2. Резисторы на 220Ом для подключения светодиодов.
3. Светодиоды чтобы моргать, хотя имеются встроенные, так что можно и без них.

# Подключение #

Обычным микро usb кабелем подключаем к компьютеру. Windows брякает и определяет ее как "Arduino Leonardo" (в диспетчере устройств раздел "Порты COM и LPT")

Ставим [Arduino IDE](https://www.arduino.cc/en/main/software)

В меню "Инструменты" выбираем "Arduino Leonardo" и порт нашей платы. Порт может изменится. В случае изменения порта, порт надо выбрать заново вручную.

После этого все готово к загрузке программ.

# blink - моргаем встроенными светодиодами #

В классической Arduino встроенный светодиод расположен на пине 13 и им можно моргать, для чего есть классический пример под названием blink входящий в состав Arduino IDE. В ATmega32U4 такого светодиода нет, и стандартный пример blink работать не будет. Зато имеются два светодиода служащими индикаторами для процессов чтения записи RX и TX. Они расположены на пинах 17 (RX) и 30 (TX), так что пришлось написать свой пример моргающий этими светодиодами.

Также добавим функционал моргания внешним светодиодом подключенным по классической схеме на пин 2. В схеме используется резистор 220Ом. В маем случае зеленый светодиод на 3 вольта и резистор на 200Ом работают нормально.

![GitHub Logo](/images/led_bb.png)

По какой то, видимо технологической причине, включение и выключение встроенных светодиодов инвертировано и значение LOW включает светодиод а значение HIGH выключает. В случае с внешним светодиодом все наоборот, так как и должно быть.

Код примера: [blink](/blink)

# button - подключаем кнопку #

Пример прост - нажали на кнопку загорелся встроенный светодиод, отпустили потух.

Оказалось, есть несколько методов подключения кнопки.
1. Через резистор на 10 кОм. Резистор используется для стабилизации нулевого сигнала (кнопка отжата), так как на пин могут влиять наводки из вне, что может привести к спонтанному срабатыванию.
2. Через встроенный резистор. Значение пина инвертировано, то есть при нажатии LOW при отпускании HIGH.
3. Сложная схема позволяющая избежать эффекта дребезга кнопки при срабатывании. Такое происходит когда контакт смыкается и размыкается, действие механическое и может коротнуть лишний раз, что может привести к ложным срабатываниям. Происходит это считанные доли секунды но Arduino достаточно быстра чтобы среагировать. Избежать подобного также можно установив задержку после нажатия клавиши на 5-10 миллисекунд, (возможно меньше, зависит от ситуации).

В связи с тем, что перед покупкой я ничего не знал про резистор на 10 кОм, я его естественно не купил. Потом, я тупанул и купил резисторов на 10 Ом =) В общем жизнь заставила углубиться в тему и узнать про встроенный резистор.

![Схема подключения кнопки напрямую](/images/button_direct_bb.png)

Меня как перфекциониста немного бомбит идея обновлять состояние пина каждую итерацию цикла, по этому в коде я решил отслеживать изменение пина кнопки и изменять состояние светодиода только в случае если изменилось значение на пине кнопки. Для этого введены переменные ledState и buttonState.

Код примера: [button](/button)

# type - работаем как клавиатура #

Итак, теперь когда есть кнопка пришло время научить ее делать нечто полезное. Выше я уже писал про то, что ATmega32U4 умеет посылать сигналы HID через USB, иначе говоря работать как клавиатура, мышь или джойстик. Настало время протестировать эту способность, будем жать кнопку `x`.

В комплекте Arduino IDE есть библиотека Keyboard.h используя которую мы может отправлять коды клавиш на USB. У либы есть минусы, она не умеет мультимедия клавиши (vol+, vol-, калькулятор и т.п.) с другой стороны позволяет отправить любой ASCII символ и спец клавиши PageUp, PageDown, F1, F2 и т.п. Позволяет задавать модификаторы, зажатый Shift, Ctrl и т.п.

Код примера: [type](/type)
